<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>กู้คืนรหัสผ่าน</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .error {
            color: red;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h2>กู้คืนรหัสผ่าน</h2>
    <div id="recoveryForm">
        <label for="username">ชื่อผู้ใช้:</label>
        <input type="text" id="username" required>
        
        <label for="securityQuestion">คำถาม:</label>
        <select id="securityQuestion" required>
            <option value="">เลือกคำถาม</option>
            <option value="pet">ชื่อสัตว์เลี้ยงตัวแรกของคุณคือ?</option>
            <option value="school">โรงเรียนประถมของคุณชื่ออะไร?</option>
            <option value="mother">นามสกุลเดิมของคุณแม่คือ?</option>
            <option value="city">คุณเกิดที่จังหวัดอะไร?</option>
            <option value="hobby">งานอดิเรกยอดโปรดตอนเป็นเด็กของคุณคืออะไร?</option>
        </select>
        
        <label for="securityAnswer">คำตอบ:</label>
        <input type="text" id="securityAnswer" required>
        
        <div id="errorMessage" class="error"></div>
        
        <button onclick="validateRecovery()">ตรวจสอบ</button>
        <center><p class="login-link"><a href="login.html">กลับไปยังหน้าเข้าสู่ระบบ</a></p></center>
    </div>

    <div id="resetPasswordForm" style="display:none;">
        <label for="newPassword">รหัสผ่านใหม่:</label>
        <input type="password" id="newPassword" required>
        
        <label for="confirmPassword">ยืนยันรหัสผ่านใหม่:</label>
        <input type="password" id="confirmPassword" required>
        
        <div id="passwordErrorMessage" class="error"></div>
        
        <button onclick="resetPassword()">เปลี่ยนรหัสผ่าน</button>
    </div>

    <script>
    function validateRecovery() {
        const username = document.getElementById('username').value;
        const securityQuestion = document.getElementById('securityQuestion').value;
        const securityAnswer = document.getElementById('securityAnswer').value;
        const errorMessage = document.getElementById('errorMessage');

        // ตรวจสอบข้อมูลที่กรอก
        if (username === '' || securityQuestion === '' || securityAnswer === '') {
            errorMessage.textContent = 'กรุณากรอกข้อมูลให้ครบถ้วน';
            return;
        }

        // ส่งข้อมูลไปตรวจสอบที่ PHP
        fetch('../php/recovery.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('recoveryForm').style.display = 'none';
                document.getElementById('resetPasswordForm').style.display = 'block';
            } else {
                errorMessage.textContent = data.message;
            }
        })
        .catch(error => {
            errorMessage.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
        });
    }

    function resetPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const passwordErrorMessage = document.getElementById('passwordErrorMessage');

        // ตรวจสอบรหัสผ่านใหม่
        if (newPassword !== confirmPassword) {
            passwordErrorMessage.textContent = 'รหัสผ่านไม่ตรงกัน';
            return;
        }
        if (newPassword.length < 6) {
            passwordErrorMessage.textContent = 'รหัสผ่านต้องมีความยาวอย่างน้อย 6 ตัวอักษร';
            return;
        }

        // ส่งรหัสผ่านใหม่ไปบันทึกที่ PHP
        fetch('../php/reset_password.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: document.getElementById('username').value,
                newPassword: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('เปลี่ยนรหัสผ่านสำเร็จ');
                window.location.href = 'login.html';
            } else {
                passwordErrorMessage.textContent = data.message;
            }
        })
        .catch(error => {
            passwordErrorMessage.textContent = 'เกิดข้อผิดพลาดในการบันทึก';
        });
    }
    </script>
</body>
</html>
