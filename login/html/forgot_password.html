<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</title>
    <link rel="stylesheet" href="../css/forgot_password.css">
</head>
<body>
    <div class="container">
        <h2>‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
        <div id="recoveryForm">
            <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
        <div class="username-container">
            <input type="text" id="username" required>
            <button type="button" onclick="checkUsername()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
        </div>
        <div id="usernameErrorMessage" class="error-message"></div>


            <label for="securityQuestion">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</label>
            <input type="text" id="securityQuestion" required disabled>


            <label for="securityAnswer">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö:</label>
            <input type="text" id="securityAnswer" required>
            <div id="errorMessage" class="error"></div>
            <button onclick="validateRecovery()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
            <p class="login-link"><a href="login.html">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></p>
        </div>

        <div id="resetPasswordForm" style="display:none;">
            <label for="newPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:</label>
            <div class="password-container">
                <input type="password" id="newPassword" required>
                <span class="toggle-icon" onclick="togglePassword('newPassword', 'toggleNewPass')">üëÅ</span>
            </div>
            
            <label for="confirmPassword">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:</label>
            <div class="password-container">
                <input type="password" id="confirmPassword" required>
                <span class="toggle-icon" onclick="togglePassword('confirmPassword', 'toggleConfirmPass')">üëÅ</span>
            </div>
            
            <div id="passwordErrorMessage" class="error"></div>
            
            <button onclick="resetPassword()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
        </div>
        
    <script>
        function checkUsername() {
            const username = document.getElementById('username').value;
            const securityQuestionInput = document.getElementById('securityQuestion');
            const errorMessage = document.getElementById('errorMessage');

            if (username === '') {
                errorMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                return;
            }

            fetch('../php/check_username.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    errorMessage.textContent = '';
                    securityQuestionInput.value = data.security_question; 
                    securityQuestionInput.disabled = false;
                } else {
                    errorMessage.textContent = data.message;
                    securityQuestionInput.value = ''; 
                    securityQuestionInput.disabled = true;
                }
            })
            .catch(error => {
                errorMessage.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
            });
        }


        function togglePassword(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.querySelector(`[onclick="togglePassword('${inputId}', '${iconId}')"]`);

            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                toggleIcon.textContent = "üôà";
            } else {
                passwordInput.type = "password";
                toggleIcon.textContent = "üëÅ";
            }
        }

    function validateRecovery() {
        const username = document.getElementById('username').value;
        const securityQuestion = document.getElementById('securityQuestion').value;
        const securityAnswer = document.getElementById('securityAnswer').value;
        const errorMessage = document.getElementById('errorMessage');

        if (username === '' || securityQuestion === '' || securityAnswer === '') {
            errorMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
            return;
        }

        fetch('../php/recovery.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('recoveryForm').style.display = 'none';
                document.getElementById('resetPasswordForm').style.display = 'block';
            } else {
                errorMessage.textContent = data.message;
            }
        })
        .catch(error => {
            errorMessage.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
        });
    }

    function resetPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const passwordErrorMessage = document.getElementById('passwordErrorMessage');

        if (newPassword !== confirmPassword) {
            passwordErrorMessage.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';
            return;
        }
        if (newPassword.length < 8) {
            passwordErrorMessage.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
            return;
        }

        fetch('../php/reset_password.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: document.getElementById('username').value,
                newPassword: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                window.location.href = 'login.html';
            } else {
                passwordErrorMessage.textContent = data.message;
            }
        })
        .catch(error => {
            passwordErrorMessage.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        });
    }
    </script>
</body>
</html>